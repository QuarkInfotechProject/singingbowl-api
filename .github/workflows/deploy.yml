name: ğŸš€ Deploy Laravel App

on:
  push:
    branches:
      - main

# Editable deployment values
env:
  SSH_HOST: "202.51.71.55"
  SSH_USER: "ubuntu"
  SSH_PORT: "22"

  PROJECT_PATH: "/var/www/api"
  BRANCH: "main"

  PHP_PATH: "/usr/bin/php"
  COMPOSER_PATH: "/usr/bin/composer"

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” SSH + Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          port: ${{ env.SSH_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }} # ssh key already working
          script_stop: false

          # IMPORTANT: pass env vars inside SSH session
          envs: PROJECT_PATH,BRANCH,PHP_PATH,COMPOSER_PATH

          script: |
            echo "ğŸš€ Starting Laravel deployment..."

            echo "ğŸ“ Entering project directory: $PROJECT_PATH"
            cd $PROJECT_PATH || { echo "âŒ Directory not found"; exit 1; }

            echo "ğŸ”„ Pulling latest code..."
            git pull origin $BRANCH || { echo 'âŒ Git pull failed'; exit 1; }

            echo "ğŸ“¦ Installing composer dependencies..."
            $PHP_PATH $COMPOSER_PATH install --no-interaction --prefer-dist --optimize-autoloader

            echo "ğŸ”‘ Generating key (safe)..."
            $PHP_PATH artisan key:generate || true

            echo "ğŸ›  Running migrations..."
            $PHP_PATH artisan migrate --force

            echo "ğŸ§¹ Clearing and optimizing..."
            $PHP_PATH artisan optimize:clear
            $PHP_PATH artisan config:cache

            echo "ğŸ‰ Laravel Deployment Complete!"